<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Registration | MyKad-LifeLink</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/Logo.png">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gov-blue': '#003366',
                        'gov-blue-light': '#E6F2FF',
                        'medical-white': '#F8FAFC',
                        'primary-blue': '#0066CC',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'brand': ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .lang-btn.active {
            background: white;
            color: #0066CC;
            font-weight: 600;
        }

        .lang-btn:not(.active) {
            background: transparent;
            color: white;
        }

        .lang-btn {
            transition: all 0.2s ease;
        }

        .lang-btn:hover {
            transform: scale(1.05);
        }

        .step-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-field {
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #0066CC;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 200px;
            border: 3px solid #0066CC;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-frame::before,
        .scan-frame::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #0066CC;
        }

        .scan-frame::before {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 12px;
        }

        .scan-frame::after {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 12px;
        }

        .tag-input {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            min-height: 44px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #E6F2FF;
            color: #0066CC;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            color: #0066CC;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: #0066CC;
            width: 32px;
            border-radius: 6px;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        body.dark-mode .step-card {
            background-color: #2d2d2d;
            border-color: #444;
            color: #f0f0f0;
        }

        body.dark-mode .input-field {
            background-color: #3a3a3a;
            border-color: #555;
            color: #f0f0f0;
        }

        body.dark-mode .input-field:focus {
            border-color: #4da3ff;
            box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.2);
        }

        body.dark-mode .tag-input {
            background-color: #3a3a3a;
            border-color: #555;
        }

        body.dark-mode .tag {
            background-color: #4a5568;
            color: #4da3ff;
        }

        body.dark-mode select {
            background-color: #3a3a3a;
            border-color: #555;
            color: #f0f0f0;
        }

        body.dark-mode textarea {
            background-color: #3a3a3a;
            border-color: #555;
            color: #f0f0f0;
        }

        body.dark-mode label {
            color: #f0f0f0;
        }

        body.dark-mode .step-dot {
            background: #555;
        }

        body.dark-mode .step-dot.active {
            background: #4da3ff;
        }

        body.dark-mode #dark-mode-toggle {
            color: white;
        }

        body.dark-mode h2 {
            color: #f0f0f0;
        }

        body.dark-mode .bg-yellow-50 {
            background-color: #3a3a00;
            border-color: #555500;
        }

        body.dark-mode .bg-yellow-50 p {
            color: #ffeb3b;
        }

        body.dark-mode .bg-blue-50 {
            background-color: #001f3a;
            border-color: #003d66;
        }

        body.dark-mode .bg-blue-50 p {
            color: #4da3ff;
        }

        /* Footer Dark Mode Styles */
        body.dark-mode nav {
            background-color: #2d2d2d !important;
            border-top-color: #444 !important;
        }

        body.dark-mode nav > div > div > div.border-l {
            border-left-color: #444 !important;
        }

        body.dark-mode nav .text-gray-900,
        body.dark-mode nav span:not([style*="#FFD700"]) {
            color: #f0f0f0 !important;
        }

        /* Keep gold color for brand name even in dark mode */
        body.dark-mode nav span[style*="#FFD700"] {
            color: #FFD700 !important;
        }

        #dark-mode-toggle {
            position: absolute;
            top: 2rem;
            right: 2rem;
            font-size: 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 100;
            transition: transform 0.2s ease;
        }

        #dark-mode-toggle:hover {
            transform: scale(1.1);
        }

        #dark-mode-toggle:active {
            transform: scale(0.9);
        }

        /* Back Button Styles */
        #back-button {
            position: absolute;
            top: 8rem;
            left: 2rem;
            font-size: 1.25rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s ease;
        }

        #back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        #back-button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-medical-white min-h-screen flex flex-col">
    <!-- Dark Mode Toggle -->
    <button id="dark-mode-toggle" aria-label="Toggle Dark Mode">ðŸŒ™</button>

    <!-- Back Button -->
    <button id="back-button" aria-label="Go Back" onclick="window.history.back();">
        <i class="fas fa-arrow-left"></i>
    </button>

    <!-- Header Section -->
    <header class="bg-gradient-to-br from-primary-blue via-gov-blue to-gov-blue relative overflow-hidden">
        <!-- Decorative Background Elements -->
        <div class="absolute top-0 right-0 w-96 h-96 bg-white opacity-5 rounded-full -mr-48 -mt-48"></div>
        
        <div class="relative z-10">
            <!-- Top Row: Language Toggle -->
            <div class="w-full px-8 pt-8 pb-4">
                <div class="flex items-center justify-between max-w-5xl mx-auto">
                    <!-- Left: Language Toggle -->
                    <div class="flex items-center gap-2">
                        <button id="lang-en" class="lang-btn active px-5 py-2 rounded-full text-sm font-semibold transition-all duration-200" data-lang="en">
                            EN
                        </button>
                        <button id="lang-bm" class="lang-btn px-5 py-2 rounded-full text-sm font-semibold transition-all duration-200" data-lang="bm">
                            BM
                        </button>
                    </div>
                </div>
            </div>

            <!-- Welcome Section -->
            <div class="max-w-5xl mx-auto px-8 pb-12">
                <div class="text-white">
                    <h1 class="text-4xl md:text-5xl font-bold mb-2">
                        Patient Registration
                    </h1>
                    <p class="text-lg text-white/90">
                        Complete your profile to access LifeLink services
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col items-center justify-center w-full px-8 py-12">
        <div class="w-full max-w-3xl">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-dot active" id="step-1-dot"></div>
                <div class="step-dot" id="step-2-dot"></div>
                <div class="step-dot" id="step-3-dot"></div>
            </div>

            <!-- Step 1: MyKad Scan -->
            <div id="step-1" class="step-card bg-white rounded-2xl p-8 shadow-lg border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center"><span data-i18n="step1.title">Identity Verification</span></h2>
                
                <div class="relative bg-gray-900 rounded-xl overflow-hidden mb-6" style="height: 400px;">
                    <!-- Camera View (Mocked) -->
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center text-white">
                            <i class="fas fa-camera text-6xl mb-4 opacity-50"></i>
                            <p class="text-lg"><span data-i18n="upload_hint">Upload your MyKad image</span></p>
                        </div>
                    </div>
                    
                    <!-- Scan Frame Overlay -->
                    <div class="scan-frame"></div>
                </div>

                <input type="file" id="mykad-file-input" accept="image/*" style="display: none;">
                <button id="upload-mykad-btn" onclick="document.getElementById('mykad-file-input').click()" class="w-full bg-primary-blue hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg">
                    <i class="fas fa-upload mr-2"></i>
                    <span data-i18n="upload_btn">Upload MyKad Image</span>
                </button>
                <p id="step-1-error" class="text-red-600 dark:text-red-400 text-sm mt-2 text-center hidden"></p>
            </div>

            <!-- Step 2: Confirm & Edit Details -->
            <div id="step-2" class="step-card bg-white rounded-2xl p-8 shadow-lg border border-gray-200 hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center"><span data-i18n="step2.title">Confirm & Edit Details</span></h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="label.fullname">Full Name</span> <span class="text-xs text-gray-500" data-i18n="label.scanned">(Scanned from MyKad)</span>
                        </label>
                        <input type="text" id="name" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="label.mykad">MyKad Number</span> <span class="text-xs text-gray-500" data-i18n="label.scanned">(Scanned from MyKad)</span>
                        </label>
                        <input type="text" id="mykad" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="label.dob">Date of Birth</span> <span class="text-xs text-gray-500" data-i18n="label.scanned">(Scanned from MyKad)</span>
                        </label>
                        <input type="date" id="dob" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="label.sex">Sex</span> <span class="text-red-500">*</span>
                        </label>
                        <select id="sex" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" required>
                            <option value="" data-i18n="select.sex">Select Sex</option>
                            <option value="male" data-i18n="option.male">Male</option>
                            <option value="female" data-i18n="option.female">Female</option>
                        </select>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong data-i18n="note.prefix">Note:</strong> <span data-i18n="note.content">Original scanned data is stored as read-only metadata to prevent identity abuse.</span>
                        </p>
                    </div>
                </div>

                <button onclick="nextStep(3)" class="w-full bg-primary-blue hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg mt-6">
                    <span data-i18n="continue_btn">Continue to Medical Information</span>
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- Step 3: Medical Self-Declaration -->
            <div id="step-3" class="step-card bg-white rounded-2xl p-8 shadow-lg border border-gray-200 hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center"><span data-i18n="step3.title">Personal Health Records</span></h2>
                <p class="text-center text-gray-500 text-sm mb-6">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    <span data-i18n="step3.subtitle">Self-Declared Information (Not verified by medical professionals)</span>
                </p>
                
                <div class="space-y-6">
                    <!-- Allergies -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="label.allergies">Allergies</label>
                        <div class="tag-input" id="allergies-container">
                            <input type="text" id="allergies-input" class="flex-1 min-w-32 border-none outline-none" placeholder="Type and press Enter to add allergy" data-i18n-placeholder="placeholder.allergy">
                        </div>
                        <div id="allergies-tags" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Chronic Conditions -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="label.conditions">Chronic Conditions</label>
                        <div class="tag-input" id="conditions-container">
                            <input type="text" id="conditions-input" class="flex-1 min-w-32 border-none outline-none" placeholder="Type and press Enter to add condition" data-i18n-placeholder="placeholder.condition">
                        </div>
                        <div id="conditions-tags" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Blood Type -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="label.blood">Blood Type</span> <span class="text-red-500">*</span>
                        </label>
                        <select id="blood-type" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" required>
                            <option value="" data-i18n="select.blood">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>

                    <!-- Risk Factors -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="label.risk">Risk Factors (Optional)</label>
                        <div class="tag-input" id="risk-factors-container">
                            <input type="text" id="risk-factors-input" class="flex-1 min-w-32 border-none outline-none bg-transparent" placeholder="Type and press Enter to add risk factor" data-i18n-placeholder="placeholder.risk">
                        </div>
                        <div id="risk-factors-tags" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Additional Notes -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="label.notes">Additional Medical Notes (Optional)</label>
                        <textarea id="notes" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" rows="3" placeholder="Any additional information you'd like to share" data-i18n-placeholder="placeholder.notes"></textarea>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <strong data-i18n="privacy.prefix">Privacy Notice:</strong> <span data-i18n="privacy.content">This information will be accessible to medical professionals during emergencies when your MyKad is scanned.</span>
                        </p>
                    </div>
                </div>

                <button onclick="completeRegistration()" class="w-full bg-primary-blue hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg mt-6 text-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span data-i18n="complete_btn">Complete Registration</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-8">
            <div class="flex items-center justify-between">
                <!-- Empty center -->
                <div class="flex items-center justify-center gap-12 flex-1">
                </div>

                <!-- Team Signature - Far Right -->
                <div class="flex flex-col items-center gap-2 pl-8 border-l border-gray-200">
                    <img src="../assets/Logo.png" alt="Full Stack Alchemist" class="h-12 w-auto" onerror="this.style.display='none'">
                    <div class="flex flex-col items-center">
                        <span class="font-brand font-bold text-xs tracking-wider text-gray-900" style="color: #FFD700;">FULL STACK ALCHEMIST</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Padding for bottom nav -->
    <div class="h-24"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 shadow-2xl text-center max-w-md mx-4">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-primary-blue mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Saving to LifeLink...</h3>
            <p class="text-gray-600">Please wait while we secure your information</p>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let currentStep = 1;
        let allergies = [];
        let conditions = [];
        let riskFactors = [];
        let ocrData = null; // Store OCR results

        // Dark Mode Toggle - Applied immediately to prevent flash
        (function() {
            const darkMode = localStorage.getItem('dark-mode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
            }
        })();

        // Dark Mode Toggle Handler
        document.addEventListener('DOMContentLoaded', () => {
            const toggleBtn = document.getElementById('dark-mode-toggle');
            const body = document.body;

            // Check for saved user preference and apply immediately
            const darkMode = localStorage.getItem('dark-mode');
            if (darkMode === 'enabled') {
                body.classList.add('dark-mode');
                if (toggleBtn) toggleBtn.textContent = 'ðŸŒ™'; // Moon emoji when in dark mode
            } else {
                if (toggleBtn) toggleBtn.textContent = 'â˜€ï¸'; // Sun emoji when in light mode
            }

            // Add event listener
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    body.classList.toggle('dark-mode');
                    
                    if (body.classList.contains('dark-mode')) {
                        localStorage.setItem('dark-mode', 'enabled');
                        toggleBtn.textContent = 'ðŸŒ™'; // Show moon when in dark mode
                    } else {
                        localStorage.setItem('dark-mode', 'disabled');
                        toggleBtn.textContent = 'â˜€ï¸'; // Show sun when in light mode
                    }
                });
            }
        });

        // Language Toggle - Load saved preference on page load
        (function() {
            const savedLang = localStorage.getItem('language') || 'en';
            const langBtns = document.querySelectorAll('.lang-btn');
            langBtns.forEach(btn => {
                if (btn.dataset.lang === savedLang) {
                    btn.classList.add('active', 'bg-white', 'text-primary-blue');
                    btn.classList.remove('bg-transparent', 'text-white');
                } else {
                    btn.classList.remove('active', 'bg-white', 'text-primary-blue');
                    btn.classList.add('bg-transparent', 'text-white');
                }
            });
        })();

        // Language Toggle - Load saved preference on page load
        function loadSavedLanguage() {
            const savedLang = localStorage.getItem('language') || 'en';
            const langBtns = document.querySelectorAll('.lang-btn');
            langBtns.forEach(btn => {
                if (btn.dataset.lang === savedLang) {
                    btn.classList.add('active', 'bg-white', 'text-primary-blue');
                    btn.classList.remove('bg-transparent', 'text-white');
                } else {
                    btn.classList.remove('active', 'bg-white', 'text-primary-blue');
                    btn.classList.add('bg-transparent', 'text-white');
                }
            });

            // Also apply translations for the saved language (in case loadSavedLanguage is used elsewhere)
            if (typeof applyTranslations === 'function') {
                applyTranslations(savedLang);
            }
        }

        // Load language immediately when script runs
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadSavedLanguage);
        } else {
            loadSavedLanguage();
        }

        // Listen for storage events to sync language changes across windows/tabs
        window.addEventListener('storage', function(e) {
            if (e.key === 'language') {
                loadSavedLanguage();
            }
        });

        // Simple translation map
        const TRANSLATIONS = {
            en: {
                title: 'Patient Registration',
                subtitle: 'Complete your profile to access LifeLink services',
                'step1.title': 'Identity Verification',
                upload_hint: 'Upload your MyKad image',
                upload_btn: 'Upload MyKad Image',
                'step2.title': 'Confirm & Edit Details',
                'label.fullname': 'Full Name',
                'label.mykad': 'MyKad Number',
                'label.dob': 'Date of Birth',
                'label.sex': 'Sex',
                'select.sex': 'Select Sex',
                'option.male': 'Male',
                'option.female': 'Female',
                'note.prefix': 'Note:',
                'note.content': 'Original scanned data is stored as read-only metadata to prevent identity abuse.',
                continue_btn: 'Continue to Medical Information',
                'step3.title': 'Personal Health Records',
                'step3.subtitle': 'Self-Declared Information (Not verified by medical professionals)',
                'label.allergies': 'Allergies',
                'label.conditions': 'Chronic Conditions',
                'label.blood': 'Blood Type',
                'select.blood': 'Select Blood Type',
                'label.risk': 'Risk Factors (Optional)',
                'label.notes': 'Additional Medical Notes (Optional)',
                'placeholder.allergy': "Type and press Enter to add allergy",
                'placeholder.condition': "Type and press Enter to add condition",
                'placeholder.risk': "Type and press Enter to add risk factor",
                'placeholder.notes': "Any additional information you'd like to share",
                'privacy.prefix': 'Privacy Notice:',
                'privacy.content': "This information will be accessible to medical professionals during emergencies when your MyKad is scanned.",
                'complete_btn': 'Complete Registration'
            },
            bm: {
                title: 'Pendaftaran Pesakit',
                subtitle: 'Lengkapkan profil anda untuk mengakses perkhidmatan LifeLink',
                'step1.title': 'Pengesahan Identiti',
                upload_hint: 'Muat naik imej MyKad anda',
                upload_btn: 'Muat Naik Imej MyKad',
                'step2.title': 'Sahkan & Sunting Maklumat',
                'label.fullname': 'Nama Penuh',
                'label.mykad': 'Nombor MyKad',
                'label.dob': 'Tarikh Lahir',
                'label.sex': 'Jantina',
                'select.sex': 'Pilih Jantina',
                'option.male': 'Lelaki',
                'option.female': 'Perempuan',
                'note.prefix': 'Nota:',
                'note.content': 'Data yang diimbas asal disimpan sebagai metadata baca-sahaja untuk mengelakkan penyalahgunaan identiti.',
                continue_btn: 'Terus ke Maklumat Perubatan',
                'step3.title': 'Rekod Kesihatan Peribadi',
                'step3.subtitle': 'Maklumat yang Diisytiharkan Sendiri (Tidak disahkan oleh profesional perubatan)',
                'label.allergies': 'Alergi',
                'label.conditions': 'Keadaan Kronik',
                'label.blood': 'Kumpulan Darah',
                'select.blood': 'Pilih Kumpulan Darah',
                'label.risk': 'Faktor Risiko (Pilihan)',
                'label.notes': 'Catatan Perubatan Tambahan (Pilihan)',
                'placeholder.allergy': 'Taip dan tekan Enter untuk menambah alergi',
                'placeholder.condition': 'Taip dan tekan Enter untuk menambah keadaan',
                'placeholder.risk': 'Taip dan tekan Enter untuk menambah faktor risiko',
                'placeholder.notes': 'Sebarang maklumat tambahan yang ingin anda kongsi',
                'privacy.prefix': 'Notis Privasi:',
                'privacy.content': 'Maklumat ini akan diakses oleh profesional perubatan semasa kecemasan apabila MyKad anda diimbas.',
                'complete_btn': 'Lengkapkan Pendaftaran'
            }
        };

        function getTranslation(lang, key) {
            const root = TRANSLATIONS[lang] || {};
            // Direct lookup for flat keys (e.g. 'step1.title')
            if (Object.prototype.hasOwnProperty.call(root, key)) {
                return root[key];
            }

            // Fallback to nested lookup (if translations are nested objects)
            const parts = key.split('.');
            let cur = root;
            for (let p of parts) {
                if (cur && typeof cur === 'object' && Object.prototype.hasOwnProperty.call(cur, p)) {
                    cur = cur[p];
                } else {
                    return null;
                }
            }
            return typeof cur === 'string' ? cur : null;
        }

        function applyTranslations(lang) {
            // text nodes
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const t = getTranslation(lang, key);
                if (t !== null) el.textContent = t;
            });

            // placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const t = getTranslation(lang, key);
                if (t !== null) el.placeholder = t;
            });

            // select options
            document.querySelectorAll('option[data-i18n]').forEach(opt => {
                const key = opt.getAttribute('data-i18n');
                const t = getTranslation(lang, key);
                if (t !== null) opt.textContent = t;
            });
        }

        // Language Toggle
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.lang-btn').forEach(b => {
                        b.classList.remove('active', 'bg-white', 'text-primary-blue');
                        b.classList.add('bg-transparent', 'text-white');
                    });
                    this.classList.add('active', 'bg-white', 'text-primary-blue');
                    this.classList.remove('bg-transparent', 'text-white');
                    
                    // Save language preference
                    const selectedLang = this.dataset.lang;
                    localStorage.setItem('language', selectedLang);

                    // Apply translations immediately
                    applyTranslations(selectedLang);
                    
                    // Dispatch storage event manually for same-tab sync
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: 'language',
                        newValue: selectedLang
                    }));
                });
            });

            // Apply initial language on DOM ready
            const initLang = localStorage.getItem('language') || 'en';
            applyTranslations(initLang);
        });

        // MyKad File Upload Handler
        const fileInput = document.getElementById('mykad-file-input');
        const uploadBtn = document.getElementById('upload-mykad-btn');
        
        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const errorMsg = document.getElementById('step-1-error');
            errorMsg.classList.add('hidden');

            // Show loading state
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            uploadBtn.disabled = true;

            try {
                // Call API to scan MyKad
                ocrData = await ApiService.patientInitialScan(file);

                // Only check for NRIC if we got a response (not a connection error)
                if (ocrData && !ocrData.nric) {
                    throw new Error('Could not extract NRIC from MyKad image. Please ensure the image is clear and try again.');
                } else if (!ocrData) {
                    // This shouldn't happen if error handling is correct, but just in case
                    throw new Error('Failed to process MyKad image. Please try again.');
                }

                // Extract birth date from NRIC (format: YYMMDD)
                // NRIC format: YYMMDD-PB-G###
                const nricParts = ocrData.nric.replace(/-/g, '').substring(0, 6);
                if (nricParts.length === 6) {
                    const year = parseInt(nricParts.substring(0, 2));
                    const month = nricParts.substring(2, 4);
                    const day = nricParts.substring(4, 6);
                    // Determine century (00-30 = 2000-2030, 31-99 = 1931-1999)
                    const fullYear = year <= 30 ? 2000 + year : 1900 + year;
                    const birthDate = `${fullYear}-${month}-${day}`;
                    
                    // Populate Step 2 fields
                    document.getElementById('name').value = ocrData.name || '';
                    document.getElementById('mykad').value = ocrData.nric || '';
                    document.getElementById('dob').value = birthDate;
                }

                // Move to next step
                nextStep(2);
            } catch (error) {
                console.error('MyKad scan error:', error);
                // Display error message in the UI
                const errorText = error.message || 'Failed to scan MyKad. Please try again.';
                errorMsg.textContent = errorText;
                errorMsg.classList.remove('hidden');
                
                // If it's a server connection error, provide additional guidance
                if (errorText.includes('Cannot connect to the server')) {
                    console.error('Backend server appears to be offline. Please start the server using: python start_server.py');
                }
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        });

        // Step Navigation
        function nextStep(step) {
            // Hide current step
            document.getElementById(`step-${currentStep}`).classList.add('hidden');
            document.getElementById(`step-${currentStep}-dot`).classList.remove('active');

            // Show next step
            currentStep = step;
            document.getElementById(`step-${currentStep}`).classList.remove('hidden');
            document.getElementById(`step-${currentStep}-dot`).classList.add('active');
        }

        // Tag Input for Allergies
        const allergiesInput = document.getElementById('allergies-input');
        const allergiesTagsContainer = document.getElementById('allergies-tags');

        allergiesInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                e.preventDefault();
                const value = this.value.trim();
                if (!allergies.includes(value)) {
                    allergies.push(value);
                    renderTags('allergies', allergies, allergiesTagsContainer);
                    this.value = '';
                }
            }
        });

        // Tag Input for Conditions
        const conditionsInput = document.getElementById('conditions-input');
        const conditionsTagsContainer = document.getElementById('conditions-tags');

        conditionsInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                e.preventDefault();
                const value = this.value.trim();
                if (!conditions.includes(value)) {
                    conditions.push(value);
                    renderTags('conditions', conditions, conditionsTagsContainer);
                    this.value = '';
                }
            }
        });

        // Tag Input for Risk Factors
        const riskFactorsInput = document.getElementById('risk-factors-input');
        const riskFactorsTagsContainer = document.getElementById('risk-factors-tags');

        riskFactorsInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                e.preventDefault();
                const value = this.value.trim();
                if (!riskFactors.includes(value)) {
                    riskFactors.push(value);
                    renderTags('risk-factors', riskFactors, riskFactorsTagsContainer);
                    this.value = '';
                }
            }
        });

        // Render Tags
        function renderTags(type, items, container) {
            container.innerHTML = '';
            items.forEach((item, index) => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${item}
                    <span class="tag-remove" data-type="${type}" data-index="${index}">Ã—</span>
                `;
                container.appendChild(tag);
            });

            // Add click handlers to remove buttons
            container.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const index = parseInt(this.dataset.index);
                    removeTag(type, index);
                });
            });
        }

        // Remove Tag
        function removeTag(type, index) {
            if (type === 'allergies') {
                allergies.splice(index, 1);
                renderTags('allergies', allergies, allergiesTagsContainer);
            } else if (type === 'conditions') {
                conditions.splice(index, 1);
                renderTags('conditions', conditions, conditionsTagsContainer);
            } else if (type === 'risk-factors') {
                riskFactors.splice(index, 1);
                renderTags('risk-factors', riskFactors, riskFactorsTagsContainer);
            }
        }

        // Complete Registration
        async function completeRegistration() {
            // Collect all data matching PatientRegistrationConfirm schema
            const fullName = document.getElementById('name').value.trim();
            const nricNumber = document.getElementById('mykad').value.trim();
            const birthDate = document.getElementById('dob').value;
            const sex = document.getElementById('sex').value;
            const bloodType = document.getElementById('blood-type').value;

            // Validate required fields
            if (!fullName || !nricNumber || !birthDate || !sex || !bloodType) {
                alert('Please fill in all required fields (marked with *).');
                return;
            }

            // Show loading overlay
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                // Step 1: Mock login to get token (required for registration confirmation)
                // Using user_id=1 as per mock auth system
                const loginResult = await ApiService.login(1, 'patient');
                
                if (!loginResult || !loginResult.access_token) {
                    throw new Error('Failed to authenticate. Please try again.');
                }

                // Store token and role
                localStorage.setItem('access_token', loginResult.access_token);
                localStorage.setItem('role', 'patient');
                localStorage.setItem('nric_number', nricNumber);
                localStorage.setItem('patientName', fullName);

                // Step 2: Prepare registration data matching PatientRegistrationConfirm schema
                const registrationData = {
                    full_name: fullName,
                    birth_date: birthDate,
                    nric_number: nricNumber,
                    sex: sex,
                    blood_type: bloodType,
                    allergies: allergies.length > 0 ? allergies : null,
                    chronic_conditions: conditions.length > 0 ? conditions : null,
                    risk_factors: riskFactors.length > 0 ? riskFactors : null,
                    emergency_contacts: null // Not collected in registration form
                };

                // Step 3: Confirm registration
                const registrationResult = await ApiService.patientConfirmRegistration(registrationData);

                if (!registrationResult) {
                    throw new Error('Registration failed. Please try again.');
                }

                if (registrationResult.status === 'exists') {
                    alert('This patient is already registered. Redirecting to login...');
                    window.location.href = '../pages/patientHomepage.html';
                    return;
                }

                if (registrationResult.status === 'created') {
                    // Success! Store patient ID and redirect
                    localStorage.setItem('patient_id', registrationResult.patient_id);
                    
                    // Show success message briefly
                    setTimeout(() => {
                        window.location.href = '../pages/patientHomepage.html';
                    }, 1000);
                } else {
                    throw new Error('Unexpected response from server.');
                }

            } catch (error) {
                console.error('Registration error:', error);
                document.getElementById('loading-overlay').classList.add('hidden');
                alert(`Registration failed: ${error.message}`);
            }
        }
    </script>
</body>
</html>
